{"id":28810,"name":"ExpenseToInvoice","userId":5930,"accountId":5682,"createdDate":"2019-08-16T20:40:39Z","steps":[{"id":204221,"onSuccess":["loopEmployees"],"onFailure":[],"name":"accessDict","type":"script","properties":{"body":"console.log (\"Can I access the dict here?\");\n\nconsole.log(Object.keys(steps.expenseSorter.expenseDict).length);"}},{"id":204222,"onSuccess":["loopEmployees"],"onFailure":[],"name":"addError","type":"script","properties":{"body":"for (var i = 0; i < steps.loopEmployees.entry.length; i++) {\n  var expense = steps.loopEmployees.entry[i];\n  expense[\"resultError\"] = steps.submitInvoiceToERP.response.body.message + \" [Request: \" + steps.submitInvoiceToERP.response.body.requestId + \"]\";\n}\n\n"}},{"id":204223,"onSuccess":["loopEmployees"],"onFailure":[],"name":"addInvoiceId","type":"script","properties":{"body":"for (var i = 0; i < steps.loopEmployees.entry.length; i++) {\n  var expense = steps.loopEmployees.entry[i];\n  expense[\"resultInvoice\"] = steps.submitInvoiceToERP.response.body.id;\n}\n\n"}},{"id":204224,"onSuccess":["loopEmployees"],"onFailure":[],"name":"expenseSorter","type":"script","properties":{"body":"var expenseArr = trigger.args.expenseArr;\n\nvar dict = {};\n\nvar i=0;\nfor (var i = 0; i < expenseArr.length; i++) {\n  var expense = expenseArr[i];\n  var key = expense[\"Employee No\"];\n\n  if ( dict[key] == null ) {\n    dict [key] = new Array();\n  }\n  dict [key].push(expense);\n}\nconsole.log (\"Total # expenses in trigger \" + i);\nconsole.log (\"Sorted expenses for \" + Object.keys(dict).length + \" employees\");\n\ndone( { \"expenseDict\":  dict } );"}},{"id":204225,"onSuccess":["loopEmployees"],"onFailure":[],"name":"globalArrayDefinition","type":"script","properties":{"body":"// Defines a global array for expenses and their invoiceId\n\nvar resultArr = [];"}},{"id":204226,"onSuccess":["submitInvoiceToERP"],"onFailure":[],"name":"handleEmployee","type":"script","properties":{"body":"var employeeName = steps.loopEmployees.entry[0][\"Employee First Name\"] + \" \" + steps.loopEmployees.entry[0][\"Employee Last Name\"]; \n\nvar invoice = {};\nvar item = [];\n\nfor (var i = 0; i < steps.loopEmployees.entry.length; i++) {\n  var expense = steps.loopEmployees.entry[i];\n  var exp = {\n    \"description\": expense[\"Description\"],\n    \"id\": \"60\",\n    \"amount\": expense[\"Net Amount\"],\n    \"quantity\": 1,\n    \"location\": \"1\",\n    \"accountCode\": \"ACCOUNT_BASED_EXPENSE_LINE_DETAIL\",\n    \"expenseType\": 21\n  }\n  \n  item.push (exp);  \n}\ninvoice.item = item;\ninvoice.currency = 1;\n\ninvoice.dueDate = \"2019-02-08T08:00:00Z\";\n\nvar today = new Date();\ninvoice.transactionDate =  \"2018-08-24T08:00:00Z\";\ninvoice.message = \"Expenses for employee \" + employeeName + \" (\" + steps.loopEmployees.entry.length + \" expense(s) in total)\";\n\ndone ({ \"invoice\": invoice });\n\n"}},{"id":204227,"onSuccess":["submitInvoiceToERP"],"onFailure":["loopEmployees"],"name":"isFirstLoop","type":"filter","properties":{"body":"done (true);\nif ( steps.loopEmployees.index == 0) {\n  console.log (\"EMPLOYEE 0\");\n  console.log (steps.loopEmployees.entry);\n  done (true);\n} \ndone (false);\n"}},{"id":204228,"onSuccess":["handleEmployee"],"onFailure":["returnFullExpenseList"],"name":"loopEmployees","type":"loop","properties":{"list":"${ Object.values(steps.expenseSorter.expenseDict) }"}},{"id":204229,"onSuccess":[],"onFailure":[],"name":"returnFullExpenseList","type":"script","properties":{"body":"done({\"expenseArr\": steps.expenseSorter.expenseDict});"}},{"id":204230,"onSuccess":["verifyResponseCode"],"onFailure":["addError"],"name":"submitInvoiceToERP","type":"elementRequest","properties":{"api":"/expenseInvoice","method":"POST","elementInstanceId":"${config.erpSystem}","body":"${steps.handleEmployee.invoice}","acceptableStatusCodes":"400,404"}},{"id":204231,"onSuccess":["addInvoiceId"],"onFailure":["addError"],"name":"verifyResponseCode","type":"filter","properties":{"body":"if(steps.submitInvoiceToERP.response && steps.submitInvoiceToERP.response.code && steps.submitInvoiceToERP.response.code==200){\n    done(true);\n} else {\n    done(false);\n}"}}],"triggers":[{"id":25506,"onSuccess":["expenseSorter"],"onFailure":[],"type":"manual","async":true,"name":"trigger","properties":{}}],"engine":"v3","active":true,"singleThreaded":false,"debugLoggingEnabled":true,"configuration":[{"id":51995,"key":"erpSystem","name":"erpSystem","type":"elementInstance","required":true}]}